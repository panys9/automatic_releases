name: build-and-test
on:
  push:
    branches: [ main ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  pull_request:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  publish-stable:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions: write-all
    steps:
      - name: Checkout Repo ‚úÖ
        uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.19
      - name: Install Tools
        run: make install-tools
      - name: Set Release Tag üîñ
        id: github_tag
        run: ./.github/workflows/scripts/set_release_tag.sh
      - name: info
        run: |
          gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          /repos/OWNER/REPO/releases \
          -f tag_name=$RELEASE_TAG \
          -f draft=false \
          -f prerelease=false \
          -f generate_release_notes=true 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          RELEASE_TAG: ${{ steps.github_tag.outputs.tag }}
      # - name: Create Github Release üìÅ
      #   run: |
      #     ghr -t $GITHUB_TOKEN -debug $RELEASE_TAG
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     RELEASE_TAG: ${{ steps.github_tag.outputs.tag }}